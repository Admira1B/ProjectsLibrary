@model ProjectsLibrary.MVC.Models.Company.IndexCompanyViewModel;

@{
    ViewData["Title"] = "Companies";
}

<div class="container col-12 py-1">

    <!-- HEADER SECTION -->
    <header class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3" role="banner">
        <button id="addCompanyBtn"
                class="btn btn-outline-secondary btn-dark text-clr-sec d-flex align-items-center gap-2"
                type="button"
                aria-label="Add new company">
            <img src="/icons/plus.svg" alt="Add company icon">
            <span>Add company</span>
        </button>

        <nav aria-label="Breadcrumb">
            <h6 class="text-center mb-0">
                ProjectsLibrary &gt; <span class="text-clr-info" aria-current="page">Companies</span>
            </h6>
        </nav>
    </header>

    <!-- SEARCH SECTION -->
    <section class="mb-4" aria-label="Search section">
        <label for="searchInput" class="visually-hidden">Search companies</label>
        <input type="search"
               id="searchInput"
               class="form-control form-control-lg"
               placeholder="Search companies..."
               aria-label="Search companies"
               style="width: 100%;">
    </section>

    <!-- TABLE SECTION -->
    <section class="table-container" aria-label="Companies list">
        <table id="companies-table"
               class="table table-bordered table-hover table-striped mb-0"
               aria-describedby="table-description">
            <caption id="table-description" class="visually-hidden">
                List of companies with their IDs, names and available actions
            </caption>
            <thead class="table-dark">
                <tr class="text-center">
                    <th scope="col">ID</th>
                    <th scope="col">Company</th>
                    <th scope="col" class="text-center">Options</th>
                </tr>
            </thead>
            <tbody>
                <!-- Server-side DataTable loading -->
            </tbody>
        </table>
    </section>

    <!-- ADD COMPANY MODAL -->
    <div id="addCompanyModal"
         class="modal fade"
         tabindex="-1"
         aria-labelledby="addCompanyModalLabel"
         aria-hidden="true"
         data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="width: 33rem;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="addCompanyModalLabel" class="modal-title h5">Add New Company</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCompanyForm"
                          asp-action="Add"
                          asp-controller="Companies"
                          method="post"
                          novalidate>
                        @Html.AntiForgeryToken()
                        <div class="mt-0 mb-2 pb-1">
                            <div class="input-group mb-3">
                                <label asp-for="CompanyAddDto.Name" class="input-group-text" for="addingCompanyNameInput">
                                    Company Name
                                </label>
                                <input id="addingCompanyNameInput"
                                       asp-for="CompanyAddDto.Name"
                                       class="form-control"
                                       placeholder="Enter company name..."
                                       aria-required="true"
                                       aria-describedby="nameValidation" />
                                <span asp-validation-for="CompanyAddDto.Name"
                                      class="invalid-feedback d-block"
                                      id="nameValidation"
                                      role="alert"></span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button"
                                    class="btn btn-danger"
                                    data-bs-dismiss="modal"
                                    aria-label="Cancel adding company">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="btn btn-primary dt-btn-edit"
                                    aria-label="Submit company form">
                                Add Company
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal fade"
         id="companyDeleteModal"
         tabindex="-1"
         aria-labelledby="companyDeleteLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="width: 33rem;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="companyDeleteLabel" class="modal-title h5">
                        Confirm Company Deletion
                    </h2>
                    <img src="icons/warning_black.svg"
                         alt="Warning icon"
                         style="height: 35px;"
                         aria-hidden="true">
                </div>
                <div class="modal-body">
                    <div class="pb-1">
                        <p class="text-center modal-text" id="deleteConfirmationText" role="alert"></p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                                aria-label="Cancel deletion">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn btn-danger"
                                id="confirmDeleteBtn"
                                aria-label="Confirm company deletion">
                            Delete Company
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script type="text/javascript">
        const CompaniesConfig = {
            urls: {
                getCompanies: '@Url.Action("Get", "Companies")',
                deleteCompany: '@Url.Action("Delete", "Companies")',
                companyDetails: '@Url.Action("Details", "Companies")'
            },
            constants: {
                pageLength: 10,
                searchDelay: 500
            }
        };

        let dataTable;
        let searchTimeout;

        $(document).ready(function () {
            initializeDataTable();
            setupEventHandlers();
        });

        function initializeDataTable() {
            try {
                dataTable = $('#companies-table').DataTable({
                    dom: "t<'row'<'col-6'i><'col-6'p>>",
                    processing: true,
                    serverSide: true,
                    orderFixed: false,
                    orderReset: false,
                    orderMulti: false,
                    order: [[0, 'asc']],
                    orderSequence: ['asc', 'desc'],
                    pageLength: CompaniesConfig.constants.pageLength,
                    pagingType: 'simple_numbers',
                    language: {
                        emptyTable: 'No companies found',
                        info: 'Showing _START_ to _END_ of _TOTAL_ companies',
                        infoEmpty: 'Showing 0 to 0 of 0 companies',
                        zeroRecords: 'No matching companies found'
                    },
                    ajax: {
                      url: CompaniesConfig.urls.getCompanies,
                      type: 'POST',
                      dataType: 'json',
                      data: function (d) {
                        var order = d.order && d.order.length ? d.order[0] : { column: 0, dir: 'asc' };
                        d.sortColumn = d.columns[order.column].name;
                        d.sortDirection = order.dir;
                        d.searchingValue = d.search.value;
                        d.searchableFieldsNames = ['name'];
                      },
                      error: function(xhr, error, thrown) {
                          console.error('DataTables AJAX error:', error);
                      }
                    },
                    columns: [
                        {
                            'data': null,
                            'name': 'Id',
                            'render': function (data, type, row) {
                                return SafeRenderer.renderIdColumn(row.id, CompaniesConfig.urls.companyDetails);
                            }
                        },
                        {
                            'data': null,
                            'name': 'Name',
                            'render': function (data, type, row) {
                                return SafeRenderer.renderNameColumn(row.id, row.name, CompaniesConfig.urls.companyDetails);
                            }
                        },
                        {
                            'data': null,
                            'render': function (data, type, row) {
                                return SafeRenderer.renderOptionsButtons(row.id, row.name, CompaniesConfig.urls.companyDetails);
                            }
                        }
                    ],
                    columnDefs: [
                        { visible: false, targets: 0 },
                        {
                            width: '16%',
                            targets: 2,
                            orderable: false
                        }
                    ]
                });

            } catch (error) {
                console.error('Error initializing Companies DataTable:', error);
            }
        }

        function setupEventHandlers() {
            setupSearchHandler();
            setupAddCompanyHandlers();
            setupDeleteHandlers();
        }

        function setupSearchHandler() {
            $("#searchInput").on("keyup", function (event) {
                const val = $(this).val();

                if (event.key === "Enter" || event.keyCode === 13) {
                    clearTimeout(searchTimeout);
                    dataTable.search(val).draw();
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function () {
                    dataTable.search(val).draw();
                }, CompaniesConfig.constants.searchDelay);
            });
        }

        function setupAddCompanyHandlers() {
            $('#addCompanyBtn').on('click', function() {
                CompanyModals.openAddModal();
            });

            $('#addCompanyForm').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });

            $('.btn-danger[data-bs-dismiss="modal"]').on('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCompanyModal'));
                modal.hide();
            });
        }

        function setupDeleteHandlers() {
            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                const companyId = $(this).data('id');
                const companyName = $(this).data('name');
                CompanyModals.openDeleteModal(companyId, companyName);
            });

            $('#confirmDeleteBtn').on('click', function() {
                const companyId = $('#companyDeleteModal').data('companyId');
                CompanyActions.deleteCompany(companyId);
            });

            $('.btn-secondary[data-bs-dismiss="modal"]').on('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('companyDeleteModal'));
                modal.hide();
            });
        }

        const CompanyModals = {
            openAddModal: function() {
                $('#addingCompanyNameInput').val('').focus();
                $('#addCompanyForm').removeClass('was-validated');

                const modal = new bootstrap.Modal(document.getElementById('addCompanyModal'));
                modal.show();
            },

            openDeleteModal: function(companyId, companyName) {
                $('#companyDeleteModal').data('companyId', companyId);
                $('#companyDeleteModal').data('companyName', companyName);

                const safeCompanyName = SafeRenderer.escapeHtml(companyName);
                $('#deleteConfirmationText').text(`Are you sure you want to delete the "${safeCompanyName}" company?`);

                $('#confirmDeleteBtn').prop('disabled', false).html('Delete Company');

                const modal = new bootstrap.Modal(document.getElementById('companyDeleteModal'));
                modal.show();
            }
        };

        const CompanyActions = {
            deleteCompany: function(companyId) {
                const $btn = $('#confirmDeleteBtn');
                const originalText = $btn.html();

                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');

                $.ajax({
                    url: `${CompaniesConfig.urls.deleteCompany}/${companyId}`,
                    type: 'DELETE',
                    dataType: 'json',
                    success: function (response) {
                        dataTable.draw();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('companyDeleteModal'));
                        modal.hide();
                    },
                    error: function(xhr, status, error) {
                        console.error('Delete company error:', error, xhr);
                        alert('Error deleting company. Please try again.');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('companyDeleteModal'));
                        modal.hide();
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            }
        };

        const SafeRenderer = {
            escapeHtml: function(unsafe) {
                if (unsafe == null) return '';
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },

            renderIdColumn: function(id, detailsUrl) {
                const safeId = this.escapeHtml(id);
                return `<a href='${detailsUrl}/${safeId}' class='dt-a-link'>${safeId}</a>`;
            },

            renderNameColumn: function(id, name, detailsUrl) {
                const safeId = this.escapeHtml(id);
                const safeName = this.escapeHtml(name || '');
                return `<a href='${detailsUrl}/${safeId}' class='dt-a-link'>${safeName}</a>`;
            },

            renderOptionsButtons: function(id, name, detailsUrl) {
                const safeId = this.escapeHtml(id);
                const safeName = this.escapeHtml(name || '');

                const editButton = `
                    <a class='btn btn-sm dt-btn-edit'
                       href='${detailsUrl}/${safeId}'
                       data-bs-toggle='tooltip'
                       title='Edit company'
                       aria-label='Edit company ${safeName}'>
                        <img src="/icons/edit.svg" alt="Edit icon" />
                    </a>`;

                const deleteButton = `
                    <a class='btn btn-sm btn-danger delete-btn'
                       href='#'
                       data-id='${safeId}'
                       data-name='${safeName}'
                       data-bs-toggle='tooltip'
                       title='Delete company'
                       aria-label='Delete company ${safeName}'>
                        <img src="/icons/delete.svg" alt="Delete icon" />
                    </a>`;

                return `
                    <div class='d-flex justify-content-center align-items-center gap-3' role='group' aria-label='Company actions'>
                        ${editButton}
                        ${deleteButton}
                    </div>`;
            }
        };

        $(document).ajaxError(function(event, jqXHR, ajaxSettings, thrownError) {
            console.error('AJAX Error:', {
                url: ajaxSettings.url,
                status: jqXHR.status,
                error: thrownError
            });
        });
    </script>
}