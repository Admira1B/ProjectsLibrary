@model ProjectsLibrary.MVC.Models.Employee.IndexEmployeeViewModel;

@{
    ViewData["Title"] = "Employees";
}

<div class="container col-12 py-1">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        @if (Model.UserRole >= EmployeeRole.Supervisor)
        {
            <a class="btn btn-outline-secondary btn-dark text-clr-sec d-flex align-items-center gap-2" asp-controller="Employees" asp-action="Add">
                <img src="/icons/plus.svg" alt="add">
                <span>Add employee</span>
            </a>
        }
        else
        {
            <span></span>
        }
        <h6 class="text-center mb-0">
            ProjectsLibrary &gt; <span class="text-clr-info">Employees</span>
        </h6>
    </div>

    <div class="mb-4">
        <input type="search"
               id="searchInput"
               class="form-control form-control-lg"
               placeholder="Search employees..."
               aria-label="Search employees"
               style="width: 100%;">
    </div>

    <div class="table-container">
        <table id="employees-table" class="table table-bordered table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr class="text-center">
                    <th>ID</th>
                    <th>Employee</th>
                    <th>Email</th>
                    <th class="text-center">Options</th>
                </tr>
            </thead>
            <tbody>
                <!-- Server-side DataTable loading -->
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="employeeDeleteModal" tabindex="-1" aria-labelledby="employeeDeleteLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="width: 33rem;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="employeeDeleteModalLabel" class="modal-title">Warning about deleting data about the employee</h5>
                    <img src="icons/warning_black.svg" alt="" style="height: 35px;" />
                </div>
                <div class="modal-body">
                    <div class="pb-1">
                        <p class="text-center modal-text"></p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button id="cancelBtn" type="button" class="btn btn-danger">Cancel</button>
                        <button id="confirmBtn" type="button" class="btn btn-primary dt-btn-edit">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeTasksModal" class="modal fade" tabindex="-1" aria-labelledby="employeeTasksModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="employeeTasksModalTitle" class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between gap-3 mt-0 pb-1 mb-2">
                        <div style="width:50%">
                            <h6 class="mt-0 mb-2">Executing tasks list</h6>
                            <ul id="executingTasksList" class="list-group mb-2 scrolling-list">
                            </ul>
                        </div>
                        <div style="width:50%">
                            <h6 class="mt-0 mb-2">Created tasks list</h6>
                            <ul id="createdTasksList" class="list-group mb-2 scrolling-list">
                            </ul>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <a id="addTaskBtn" class="btn btn-primary dt-btn-edit d-flex align-items-center gap-2" style="width: 20%"
                           asp-controller="Tasks" asp-action="Add">
                            <img src="/icons/plus.svg" alt="add">
                            <span>Add task</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeProjectsModal" class="modal fade" tabindex="-1" aria-labelledby="employeeProjectsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="width:30rem;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="employeeProjectsModalTitle" class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <h6 class="mt-0 mb-2">Managed projects</h6>
                        <ul id="managedProjectsList" class="list-group mb-2 scrolling-list">
                        </ul>
                    </div>
                    <div>
                        <h6 class="mt-0 mb-2">Working on projects</h6>
                        <ul id="executingProjectsList" class="list-group mb-2 scrolling-list">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        let table;
        let searchTimeout;
        let userRole = @((int)Model.UserRole);
        let supervisorRole = @((int)EmployeeRole.Supervisor);

        $(document).ready(function () {
            table = $('#employees-table').DataTable({
                dom: "t<'row'<'col-6'i><'col-6'p>>",
                processing: true,
                serverSide: true,
                orderFixed: false,
                orderReset: false,
                orderMulti: false,
                order: [[0, 'asc']],
                orderSequence: ['asc', 'desc'],
                pageLength: 10,
                pagingType: 'simple_numbers',
                ajax: {
                  url: 'Employees/Get',
                  type: 'POST',
                  dataType: 'json',
                  data: function (d) {
                    var order = d.order && d.order.length ? d.order[0] : { column: 0, dir: 'asc' };
                    d.sortColumn = d.columns[order.column].name;
                    d.sortDirection = order.dir;
                    d.searchingValue = d.search.value;
                    d.searchableFieldsNames = ['firstName', 'lastName'];
                  }
                },
                columns: [
                    {
                        'data': null,
                        'name': 'Id',
                        'render': function (data, type, row) {
                            return renderIdColumn(row.id);
                        }
                    },
                    {
                        'data': null,
                        'name': 'FirstName',
                        'render': function (data, type, row) {
                            return renderNameColumn(row.id, row.firstName, row.lastName, userRole, supervisorRole)
                        }
                    },
                    {
                        'data': null,
                        'name': 'Email',
                        'render': function (data, type, row) {
                            return renderEmailColumn(row.email)
                        }
                    },
                    {
                        'data': null,
                        'render': function (data, type, row) {
                            return renderOptionsButtons(row.id, row.firstName, row.lastName, userRole, supervisorRole)
                        }
                    }
                ],
                columnDefs: [
                    { visible: false, targets: 0 },
                    { width: '40%', targets: 1 },
                    { width: '40%', targets: 2 },
                    {
                        'targets': 3,
                        "orderable": false
                    },
                ],
            });
        });

        function renderIdColumn(id) {
            return `<a href='/Employees/Details/${id}' class='dt-a-link'>${id}</a>`;
        };

        function renderNameColumn(id, firstname, lastname, userRole, supervisorRole) {
            return (userRole >= supervisorRole) ? `<a href='/Employees/Details/${id}' class='dt-a-link'>${firstname + ' ' + lastname}</a>` 
                    : `<p href='/Employees/Details/${id}'>${firstname + ' ' + lastname}</p>`;
        };

        function renderEmailColumn(status) {
            return `<span class="text-muted"><strong>${status ?? ''}</strong></span>`;
        };

        function renderOptionsButtons(id, firstname, lastname, userRole, supervisorRole) {
            return `<div class='d-flex justify-content-center align-items-center gap-3'>
                        ${(userRole >= supervisorRole) ? `
                            <a class='btn btn-sm dt-btn-edit' href='/Employees/Details/${id}' data-bs-toggle='tooltip' title='Edit'>
                                <img src="icons/edit.svg" alt="edit" />
                            </a>` : ``}
                        <a id='employeeTasksBtn' class='btn btn-sm btn-info' href='#' data-id='${id}' data-name='${firstname} ${lastname}' data-bs-toggle='tooltip' title='View employees tasks'>
                            <img src="icons/employee_tasks.svg" alt="tasks" />
                        </a>
                        <a id='employeeProjectsBtn' class='btn btn-sm btn-info' href='#' data-id='${id}' data-name='${firstname} ${lastname}'  data-bs-toggle='tooltip' title='View employees projects'>
                            <img src="icons/employee_projects.svg" alt="projects" />
                        </a>
                        ${(userRole >= supervisorRole) ? `
                            <a class='btn btn-sm btn-danger delete-btn' href='#' data-id='${id}' data-name='${firstname} ${lastname}' data-bs-toggle='tooltip' title='Delete'>
                                <img src="icons/delete.svg" alt="delete" />
                            </a>` : ``}
                    </div>`;
        }

        $("#searchInput").on("keyup", function (event) {
            const val = $(this).val();

            if (event.key === "Enter" || event.keyCode === 13) {
                clearTimeout(searchTimeout);

                table.search(val).draw();
                return;
            }

            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(function () {
                table.search(val).draw();
            }, 1500);
        });

        // Employee tasks modal window events
        $(document).on('click', '#employeeTasksBtn', function(e) {
            e.preventDefault();

            const id = $(this).data('id');
            const name = $(this).data('name');

            initializeEmployeeTasksModal(id, name);
        })

        async function initializeEmployeeTasksModal(employeeId, name) {
            const modal = new bootstrap.Modal(document.getElementById('employeeTasksModal'));
            const modalTitle = $('#employeeTasksModalTitle');
            const executingTasksList = $('#executingTasksList').empty();
            const createdTasksList = $('#createdTasksList').empty();

            $('#employeeTasksModal').data('employeeId', employeeId);

            modalTitle.text(`${name} tasks info`);

            const employee = await $.ajax({
                url: `/Employees/GetEmployeeWithTasks/${employeeId}`,
                method: 'GET',
                dataType: 'json'
            });

            if(employee.executingTasks.length === 0) {
                 executingTasksList.append('<li>Employee have no executing tasks yet</li>');
            } else {
                employee.executingTasks.forEach(task => {
                    executingTasksList.append(
                        `<li>
                        <a href='/Tasks/Details/${task.id}' class='dt-a-link'>${task.name}</a>: ${task.statusString}
                        </li>`
                    );
                });
            };

            if(employee.createdTasks.length === 0) {
                 createdTasksList.append('<li>Employee has not created any tasks yet</li>');
            } else {
                employee.createdTasks.forEach(task => {
                    createdTasksList.append(
                        `<li>
                        <a href='/Tasks/Details/${task.id}' class='dt-a-link'>${task.name}</a>: ${task.statusString}
                        </li>`
                    );
                });
            };

            modal.show();
        }

        // Employee projects modal window events
        $(document).on('click', '#employeeProjectsBtn', function(e) {
            e.preventDefault();

            const id = $(this).data('id');
            const name = $(this).data('name');

            initializeEmployeeProjectsModal(id, name);
        })

        async function initializeEmployeeProjectsModal(employeeId, name) {
            const modal = new bootstrap.Modal(document.getElementById('employeeProjectsModal'));
            const modalTitle = $('#employeeProjectsModalTitle');
            const managedProjectsList = $('#managedProjectsList').empty();
            const executingProjectsList = $('#executingProjectsList').empty();

            $('#employeeProjectsModal').data('employeeId', employeeId);

            modalTitle.text(`${name} projects info`);

            const employee = await $.ajax({
                url: `/Employees/GetEmployeeWithProjects/${employeeId}`,
                method: 'GET',
                dataType: 'json'
            });

            if(employee.managedProjects.length === 0) {
                 managedProjectsList.append('<li>Employee have no managed projects</li>');
            } else {
                employee.managedProjects.forEach(project => {
                    managedProjectsList.append(
                        `<li>
                        <a href='/Projects/Details/${project.id}' class='dt-a-link'>${project.name}</a>: ${formatDate(project.startDate, 'dd.MM.yyyy')} - ${formatDate(project.endDate, 'dd.MM.yyyy')}
                        </li>`
                    );
                });
            };
            if(employee.workingProjects.length === 0) {
                 executingProjectsList.append('<li>The employee is not yet working on any project</li>');
            } else {
                employee.workingProjects.forEach(project => {
                    executingProjectsList.append(
                        `<li>
                        <a href='/Projects/Details/${project.id}' class='dt-a-link'>${project.name}</a>: ${formatDate(project.startDate, 'dd.MM.yyyy')} - ${formatDate(project.endDate, 'dd.MM.yyyy')}
                        </li>`
                    );
                });
            };

            modal.show();
        }

        function formatDate(dateString, format) {
            const parsedDate = new Date(dateString);

            const day = ('0' + parsedDate.getDate()).slice(-2);
            const month = ('0' + (parsedDate.getMonth() + 1)).slice(-2);
            const year = parsedDate.getFullYear();

            if (format === 'dd.MM.yyyy') {
                return `${day}.${month}.${year}`;
            }
            if (format === 'dd/MM/yyyy') {
                return `${day}/${month}/${year}`;
            }

            return `${day}-${month}-${year}`;
        }

        $(document).on('click', '.delete-btn', function(e) {
            e.preventDefault();

            const id = $(this).data('id');
            const name = $(this).data('name');

            $('#employeeDeleteModal').data('employeeId', id);
            $('#employeeDeleteModal').data('employeeName', name);

            $('#employeeDeleteModal .modal-body p').text(`Are you sure you want to delete the ${name} employee?`);

            var modal = new bootstrap.Modal(document.getElementById('employeeDeleteModal'));
            modal.show();
        });

        $('#confirmBtn').on('click', function() {
            const id = $('#employeeDeleteModal').data('employeeId');

            $.ajax({
                url: `Employees/Delete/${id}`,
                type: 'DELETE',
                dataType: 'json',
                success: function (response) {
                    table.draw();
                },
            });

            var modal = bootstrap.Modal.getInstance(document.getElementById('employeeDeleteModal'));
            modal.hide();
        });

        $('#cancelBtn').on('click', function() {
            var modal = bootstrap.Modal.getInstance(document.getElementById('employeeDeleteModal'));
            modal.hide();
        });
    </script>
}